{% extends 'base.html' %}
{% block content %}

<!-- Heading and Action Buttons -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">3CX Records</h4>
  <div class="d-flex gap-2">
    <a href="{% url 'menu' %}" class="btn btn-outline-secondary btn-sm" title="Back to Menu">
      <i class="bi bi-arrow-left"></i> Back to Menu
    </a>
    <a href="{% url 'add_threecx_record' %}" id="add-record-btn" class="btn btn-primary btn-sm" title="Add New Record">
      <i class="bi bi-plus-lg"></i> Add Record
    </a>
  </div>
</div>

<!-- Search and Filters -->
<form method="get" class="row g-2 mb-3 align-items-center" id="filter-form" role="search" aria-label="Filter records">
  <div class="col-auto">
    <input
      type="text"
      name="search"
      class="form-control form-control-sm"
      placeholder="Search"
      value="{{ search_query }}"
      aria-label="Search records"
      id="search-input"
      autocomplete="off"
    />
  </div>
  <div class="col-auto">
    <select name="sip_provider" class="form-select form-select-sm" aria-label="Filter by SIP Provider" id="sip-select">
      <option value="">All SIP Providers</option>
      {% for sip in sip_providers %}
        <option value="{{ sip }}" {% if sip == selected_sip %}selected{% endif %}>{{ sip }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <select name="license_type" class="form-select form-select-sm" aria-label="Filter by License Type" id="license-select">
      <option value="">All License Types</option>
      {% for lic in license_types %}
        <option value="{{ lic }}" {% if lic == selected_license %}selected{% endif %}>{{ lic }}</option>
      {% endfor %}
    </select>
  </div>
</form>

<!-- Bulk Actions -->
<div id="bulk-actions" class="bulk-actions mb-3" aria-live="polite" aria-atomic="true" role="region">
  <button id="send-email-btn" class="btn btn-primary btn-sm" disabled>Send Notification</button>

  <!-- Export Form -->
  <form id="export-form" method="post" action="{% url 'export_selected_records' %}" style="display:inline;">
    {% csrf_token %}
    <input type="hidden" name="emails" id="export-emails" value="" />
    <button type="submit" id="export-btn" class="btn btn-success btn-sm" disabled>Export Selected</button>
  </form>
</div>

<!-- Table -->
<div class="table-responsive">
  <table class="table table-striped table-hover table-bordered" role="grid">
    <thead class="table-primary">
      <tr>
        <th scope="col">
          <input type="checkbox" id="select-all" title="Select All" aria-label="Select All Records" />
        </th>
        <th scope="col">Company Name</th>
        <th scope="col">Email</th>
        <th scope="col">Contact Details</th>
        <th scope="col">SIP Provider</th>
        <th scope="col">FQDN</th>
        <th scope="col">License Type</th>
        <th scope="col">Details</th>
      </tr>
    </thead>
    <tbody>
      {% for record in records %}
        <tr data-href="{% url 'threecx_record' record.id %}" tabindex="0" role="row" aria-label="Record {{ record.company_name }}">
          <td>
            <input type="checkbox" class="record-checkbox" value="{{ record.email_address }}" aria-label="Select {{ record.company_name }}" />
          </td>
          <td>{{ record.company_name }}</td>
          <td>{{ record.email_address }}</td>
          <td>{{ record.contact_details }}</td>
          <td>{{ record.get_sip_provider_display }}</td>
          <td>{{ record.fqdn }}</td>
          <td>{{ record.get_license_type_display }}</td>
          <td>
            <a href="{% url 'threecx_record' record.id %}" class="btn btn-sm btn-outline-primary" title="View Record">View</a>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="8" class="text-center">No records found.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Pagination Controls -->
<div class="d-flex justify-content-between align-items-center mt-3" aria-label="Pagination controls">
  <!-- Page size selector -->
  <div>
    <form method="get" id="page-size-form" class="d-inline-block" aria-label="Select number of records per page">
      <input type="hidden" name="search" value="{{ search_query }}">
      <input type="hidden" name="sip_provider" value="{{ selected_sip }}">
      <input type="hidden" name="license_type" value="{{ selected_license }}">
      <label for="page-size-select" class="form-label me-2"></label>
      <select name="page_size" id="page-size-select" class="form-select form-select-sm d-inline-block" style="width: auto;">
        <option value="20" {% if page_size == 20 %}selected{% endif %}>20</option>
        <option value="50" {% if page_size == 50 %}selected{% endif %}>50</option>
        <option value="100" {% if page_size == 100 %}selected{% endif %}>100</option>
      </select>
    </form>
  </div>

  <!-- Pagination buttons -->
  <nav aria-label="Page navigation">
    <ul class="pagination pagination-sm mb-0">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a
            class="page-link"
            href="?page={{ page_obj.previous_page_number }}&page_size={{ page_size }}&search={{ search_query }}&sip_provider={{ selected_sip }}&license_type={{ selected_license }}"
            aria-label="Previous page"
          >
            &laquo;
          </a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link" aria-disabled="true">&laquo;</span>
        </li>
      {% endif %}

      <li class="page-item disabled">
        <span class="page-link">
          Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>
      </li>

      {% if page_obj.has_next %}
        <li class="page-item">
          <a
            class="page-link"
            href="?page={{ page_obj.next_page_number }}&page_size={{ page_size }}&search={{ search_query }}&sip_provider={{ selected_sip }}&license_type={{ selected_license }}"
            aria-label="Next page"
          >
            &raquo;
          </a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link" aria-disabled="true">&raquo;</span>
        </li>
      {% endif %}
    </ul>
  </nav>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmSendModal" tabindex="-1" aria-labelledby="confirmSendModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-primary">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmSendModalLabel">Confirm Notification</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to send a notification to <span id="selected-count"></span> selected record(s)?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary btn-sm" id="confirmSendBtn">Yes, Send</button>
      </div>
    </div>
  </div>
</div>

<!-- Inline CSS for filter inputs and bulk actions -->
<style>
  .bulk-actions {
    display: none;
  }
  .bulk-actions.visible {
    display: block;
  }

  #filter-form input[type="text"],
  #filter-form select {
    background-color: #F4F6F8;
    border: 1px solid #ced4da;
    color: #1b1b1b;
    box-shadow: none;
  }

  #filter-form input[type="text"]::placeholder {
    color: #6c757d;
  }

  #filter-form input[type="text"]:focus,
  #filter-form select:focus {
    background-color: #F4F6F8;
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25);
    outline: none;
  }
</style>

<!-- JavaScript for interaction -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const selectAll = document.getElementById('select-all');
  const bulkActions = document.getElementById('bulk-actions');
  const sendEmailBtn = document.getElementById('send-email-btn');
  const exportBtn = document.getElementById('export-btn');
  const addRecordBtn = document.getElementById('add-record-btn');
  const form = document.getElementById('filter-form');
  const searchInput = document.getElementById('search-input');
  const sipSelect = document.getElementById('sip-select');
  const licenseSelect = document.getElementById('license-select');
  const checkboxes = document.querySelectorAll('.record-checkbox');
  const pageSizeSelect = document.getElementById('page-size-select');
  const exportEmailsInput = document.getElementById('export-emails');
  const exportForm = document.getElementById('export-form');

  // Submit filter form on filter changes
  // Debounce function to limit rapid submissions
  function debounce(func, delay) {
    let timeout;
    return function (...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

  // Instant search on input with debounce (500ms)
  searchInput.addEventListener('input', debounce(() => {
    form.submit();
  }, 500));

  // SIP and License filters submit on change
  sipSelect.addEventListener('change', () => form.submit());
  licenseSelect.addEventListener('change', () => form.submit());

  // Page size form submit on change
  pageSizeSelect.addEventListener('change', () => {
    document.getElementById('page-size-form').submit();
  });

  // Row click navigates to detail, unless clicking checkbox or buttons
  document.querySelectorAll('tbody tr').forEach(row => {
    row.addEventListener('click', (e) => {
      if (
        e.target.type === 'checkbox' ||
        e.target.closest('a, button')
      ) {
        return; // Ignore clicks on checkboxes or links/buttons
      }
      const href = row.dataset.href;
      if (href) {
        window.location.href = href;
      }
    });

    // Make row keyboard accessible with Enter key
    row.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        const href = row.dataset.href;
        if (href) {
          window.location.href = href;
        }
      }
    });
  });

  // Manage checkbox selection state and bulk action visibility
  function updateBulkActions() {
    const checkedBoxes = document.querySelectorAll('.record-checkbox:checked');
    const count = checkedBoxes.length;

    if (count > 0) {
      bulkActions.classList.add('visible');
      sendEmailBtn.disabled = false;
      exportBtn.disabled = false;
      // Update hidden export input with emails joined by commas
      const emails = Array.from(checkedBoxes).map(cb => cb.value);
      exportEmailsInput.value = emails.join(',');
    } else {
      bulkActions.classList.remove('visible');
      sendEmailBtn.disabled = true;
      exportBtn.disabled = true;
      exportEmailsInput.value = '';
      selectAll.checked = false;
    }
  }

  // Checkbox event listeners
  checkboxes.forEach(cb => {
    cb.addEventListener('change', updateBulkActions);
  });

  // Select all checkbox logic
  selectAll.addEventListener('change', () => {
    checkboxes.forEach(cb => {
      cb.checked = selectAll.checked;
    });
    updateBulkActions();
  });

  // Send Email Button - open confirmation modal
  const confirmSendModal = new bootstrap.Modal(document.getElementById('confirmSendModal'));
  const selectedCountSpan = document.getElementById('selected-count');
  const confirmSendBtn = document.getElementById('confirmSendBtn');

  sendEmailBtn.addEventListener('click', () => {
    const selectedCount = document.querySelectorAll('.record-checkbox:checked').length;
    selectedCountSpan.textContent = selectedCount;
    confirmSendModal.show();
  });

  // Confirm send notification logic
  confirmSendBtn.addEventListener('click', () => {
    confirmSendModal.hide();
    // Redirect to send notification page with selected emails as query param (or handle differently)
    const emails = Array.from(document.querySelectorAll('.record-checkbox:checked')).map(cb => cb.value);
    if (emails.length > 0) {
      // Example redirect, adapt if you have another plan
      const url = new URL("{% url 'send_notification' %}", window.location.origin);
      url.searchParams.append('emails', emails.join(','));
      window.location.href = url.toString();
    }
  });

});
</script>

{% endblock content %}
