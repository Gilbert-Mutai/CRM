{% extends 'base.html' %}
{% block content %}

<!-- Heading and Action Buttons -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">3CX Records</h4>
  <div class="d-flex gap-2">
    <a href="{% url 'menu' %}" class="btn btn-outline-secondary btn-sm" title="Back to Menu">
      <i class="bi bi-arrow-left"></i> Back to Menu
    </a>
    <a href="{% url 'add_threecx_record' %}" id="add-record-btn" class="btn btn-primary btn-sm" title="Add New Record">
      <i class="bi bi-plus-lg"></i> Add Record
    </a>
  </div>
</div>

<!-- Bulk Actions -->
<div id="bulk-actions" class="bulk-actions mb-3">
  <button id="send-email-btn" class="btn btn-primary btn-sm">Send Notification</button>
</div>

<!-- Table -->
<div class="table-responsive">
  <table class="table table-striped table-hover table-bordered">
    <thead class="table-primary">
      <tr>
        <th><input type="checkbox" id="select-all" title="Select All" aria-label="Select All" /></th>
        <th>Company Name</th>
        <th>Email</th>
        <th>Contact Details</th>
        <th>SIP Provider</th>
        <th>FQDN</th>
        <th>Licence Type</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody>
      {% for record in records %}
        <tr data-href="{% url 'threecx_record' record.id %}">
          <td><input type="checkbox" class="record-checkbox" value="{{ record.email_address }}" aria-label="Select {{ record.company_name }}"></td>
          <td>{{ record.company_name }}</td>
          <td>{{ record.email_address }}</td>
          <td>{{ record.contact_details }}</td>
          <td>{{ record.get_sip_provider_display }}</td>
          <td>{{ record.fqdn }}</td>
          <td>{{ record.get_licence_type_display }}</td>
          <td>
            <a href="{% url 'threecx_record' record.id %}" class="btn btn-sm btn-outline-primary" title="View Record">View</a>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- CSS: Toggle visibility of bulk actions -->
<style>
  .bulk-actions {
    display: none;
  }
  .bulk-actions.visible {
    display: block;
  }
</style>

<!-- JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const selectAll = document.getElementById('select-all');
  const bulkActions = document.getElementById('bulk-actions');

  function getCheckboxes() {
    return document.querySelectorAll('.record-checkbox');
  }

  function toggleBulkActionButton() {
    const selectedCount = Array.from(getCheckboxes()).filter(cb => cb.checked).length;
    const addButton = document.getElementById('add-record-btn');

    if (selectedCount > 0) {
      bulkActions.classList.add('visible');
      if (addButton) addButton.style.display = 'none';
    } else {
      bulkActions.classList.remove('visible');
      if (addButton) addButton.style.display = 'inline-block';
    }
  }

  // Make rows clickable unless target is a checkbox or link
  document.querySelectorAll('tbody tr[data-href]').forEach(row => {
    row.style.cursor = 'pointer';
    row.addEventListener('click', function (e) {
      if (!e.target.closest('a') && e.target.type !== 'checkbox') {
        window.location = this.dataset.href;
      }
    });
  });

  // Select All toggle
  selectAll.addEventListener('change', function () {
    getCheckboxes().forEach(cb => {
      cb.checked = this.checked;
      cb.closest('tr').classList.toggle('table-active', this.checked);
    });
    toggleBulkActionButton();
  });

  // Individual checkbox toggles
  getCheckboxes().forEach(cb => {
    cb.addEventListener('change', function () {
      this.closest('tr').classList.toggle('table-active', this.checked);
      toggleBulkActionButton();

      const allChecked = Array.from(getCheckboxes()).every(chk => chk.checked);
      selectAll.checked = allChecked;
    });
  });

  // Send Notification button
  document.getElementById('send-email-btn').addEventListener('click', function () {
    const selectedEmails = Array.from(getCheckboxes())
      .filter(cb => cb.checked)
      .map(cb => cb.value);

    if (selectedEmails.length === 0) {
      alert('Please select at least one record to send notification.');
      return;
    }

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = "{% url 'send_notification' %}";
    form.style.display = 'none';

    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = '{{ csrf_token }}';
    form.appendChild(csrfInput);

    const emailsInput = document.createElement('input');
    emailsInput.type = 'hidden';
    emailsInput.name = 'emails';
    emailsInput.value = selectedEmails.join(',');
    form.appendChild(emailsInput);

    document.body.appendChild(form);

    // Prevent duplicate submissions
    document.getElementById('send-email-btn').disabled = true;
    form.submit();
  });
});
</script>

{% endblock %}
