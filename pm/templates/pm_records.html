{% extends 'base.html' %}
{% block content %}

  <!-- Heading and Action Buttons -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">Project Records</h4>
  <div class="d-flex gap-2">
    <a href="{% url 'menu' %}" class="btn btn-outline-secondary btn-sm" title="Back to Menu">
      <i class="bi bi-arrow-left"></i> Back
    </a>
    <a href="{% url 'add_pm_record' %}" id="add-record-btn" class="btn btn-outline-primary btn-sm" title="Add New Project">
      <i class="bi bi-plus-lg"></i> Add Project
    </a>
  </div>
</div>

<!-- Combined Filters and Bulk Actions -->
<form method="get" class="mb-3" id="filter-form">
  <div class="row g-2 align-items-center">
    <!-- Filters -->
    <div class="col-auto" style="min-width: 220px;">
      <input
        type="text"
        name="search"
        class="form-control form-control-sm"
        placeholder="Search"
        value="{{ search_query }}"
        id="search-input"
        autocomplete="off"
        aria-label="Search projects"
      />
    </div>
    <div class="col-auto" style="min-width: 180px;">
      <select name="status" class="form-select form-select-sm" aria-label="Filter by Project Status" id="status-select">
        <option value="">All Statuses</option>
        {% for status in project_statuses %}
          <option value="{{ status }}" {% if status == selected_status %}selected{% endif %}>{{ status }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto" style="min-width: 180px;">
      <select name="priority" class="form-select form-select-sm" aria-label="Filter by Priority" id="priority-select">
        <option value="">All Priorities</option>
        {% for priority in project_priorities %}
          <option value="{{ priority }}" {% if priority == selected_priority %}selected{% endif %}>{{ priority }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Bulk Action Buttons (Right-Aligned) -->
    <div class="col-auto ms-auto">
      <div id="bulk-action-buttons" style="display: none;">
        <a href="#" id="export-selected" class="btn btn-sm btn-success">Export</a>
      </div>
    </div>
  </div>
</form>

<!-- Hidden export form -->
<form id="export-form" method="post" action="{% url 'export_selected_pm_records' %}">
  {% csrf_token %}
  <input type="hidden" name="emails" id="export-emails" value="">
</form>

<!-- Table -->
<div class="table-responsive">
  <table class="table table-striped table-hover table-bordered" role="grid">
    <thead class="table-primary">
      <tr>
        <th scope="col">
          <input type="checkbox" id="select-all" title="Select All" aria-label="Select All Projects" />
        </th>
        <th scope="col">Client</th>
        <th scope="col">Start Date</th>
        <th scope="col">End Date</th>
        <th scope="col">Status</th>
        <th scope="col">Details</th>
      </tr>
    </thead>
    <tbody>
      {% for project in projects %}
        <tr data-href="{% url 'pm_record' project.id %}" tabindex="0" role="row" aria-label="Project {{ project.name }}">
          <td>
            <input type="checkbox" class="record-checkbox" value="{{ project.client.email }}" aria-label="Select {{ project.name }}" />
          </td>
          <td>{{ project.customer_name }}</td>
          <td>{{ project.date_of_request|date:"Y-m-d" }}</td>
          <td>{{ project.date_of_completion|date:"Y-m-d" }}</td>
          <td>{{ project.get_status_display }}</td>
          <td>
            <a href="{% url 'pm_record' project.id %}" class="btn btn-sm btn-outline-primary" title="View Project">View</a>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="8" class="text-center">No projects found.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Pagination Controls -->
<div class="d-flex justify-content-between align-items-center mt-3" aria-label="Pagination controls">
  <div>
    <form method="get" id="page-size-form" class="d-inline-block" aria-label="Select number of projects per page">
      <input type="hidden" name="search" value="{{ search_query }}">
      <input type="hidden" name="status" value="{{ selected_status }}">
      <input type="hidden" name="priority" value="{{ selected_priority }}">
      <select name="page_size" id="page-size-select" class="form-select form-select-sm d-inline-block" style="width: auto;">
        <option value="20" {% if page_size == 20 %}selected{% endif %}>20</option>
        <option value="50" {% if page_size == 50 %}selected{% endif %}>50</option>
        <option value="100" {% if page_size == 100 %}selected{% endif %}>100</option>
      </select>
    </form>
  </div>

  <nav aria-label="Page navigation">
    <ul class="pagination pagination-sm mb-0">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a
            class="page-link"
            href="?page={{ page_obj.previous_page_number }}&page_size={{ page_size }}&search={{ search_query }}&status={{ selected_status }}&priority={{ selected_priority }}"
            aria-label="Previous page"
          >
            &laquo;
          </a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link" aria-disabled="true">&laquo;</span>
        </li>
      {% endif %}

      <li class="page-item disabled">
        <span class="page-link">
          Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>
      </li>

      {% if page_obj.has_next %}
        <li class="page-item">
          <a
            class="page-link"
            href="?page={{ page_obj.next_page_number }}&page_size={{ page_size }}&search={{ search_query }}&status={{ selected_status }}&priority={{ selected_priority }}"
            aria-label="Next page"
          >
            &raquo;
          </a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link" aria-disabled="true">&raquo;</span>
        </li>
      {% endif %}
    </ul>
  </nav>
</div>

<style>
  .bulk-actions {
    display: none;
  }
  .bulk-actions.visible {
    display: block;
  }

  #filter-form input[type="text"],
  #filter-form select {
    background-color: #F4F6F8;
    border: 1px solid #ced4da;
    color: #1b1b1b;
    box-shadow: none;
  }

  #filter-form input[type="text"]::placeholder {
    color: #6c757d;
  }

  #filter-form input[type="text"]:focus,
  #filter-form select:focus {
    background-color: #F4F6F8;
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25);
    outline: none;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const selectAll = document.getElementById('select-all');
  const bulkActions = document.getElementById('bulk-action-buttons');
  const exportBtn = document.getElementById('export-selected');
  const form = document.getElementById('filter-form');
  const searchInput = document.getElementById('search-input');
  const statusSelect = document.getElementById('status-select');
  const prioritySelect = document.getElementById('priority-select');
  const exportEmailsInput = document.getElementById('export-emails');

  function toggleBulkActions() {
    const anyChecked = document.querySelectorAll('.record-checkbox:checked').length > 0;
    bulkActions.style.display = anyChecked ? 'block' : 'none';
  }

  selectAll.addEventListener('change', () => {
    const checkboxes = document.querySelectorAll('.record-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    toggleBulkActions();
  });

  document.querySelectorAll('.record-checkbox').forEach(cb => {
    cb.addEventListener('change', () => {
      const allCheckboxes = document.querySelectorAll('.record-checkbox');
      const checkedBoxes = document.querySelectorAll('.record-checkbox:checked');

      selectAll.checked = checkedBoxes.length === allCheckboxes.length;
      toggleBulkActions();
    });
  });

  // Click on row navigates to detail (except if clicked on checkbox or button)
  document.querySelectorAll('tbody tr[data-href]').forEach(row => {
    row.addEventListener('click', e => {
      if (
        e.target.type !== 'checkbox' &&
        !e.target.closest('a') &&
        !e.target.closest('button')
      ) {
        window.location.href = row.getAttribute('data-href');
      }
    });

    row.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        window.location.href = row.getAttribute('data-href');
      }
    });
  });

  // Filter form submits on filter change or enter key on search
  searchInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      form.submit();
    }
  });
  statusSelect.addEventListener('change', () => form.submit());
  prioritySelect.addEventListener('change', () => form.submit());

  // Export selected action
  exportBtn.addEventListener('click', e => {
    e.preventDefault();
    const selectedEmails = Array.from(document.querySelectorAll('.record-checkbox:checked')).map(cb => cb.value);
    if (selectedEmails.length === 0) {
      alert('Please select at least one project/client to export.');
      return;
    }
    exportEmailsInput.value = selectedEmails.join(',');
    document.getElementById('export-form').submit();
  });
});
</script>

{% endblock %}
