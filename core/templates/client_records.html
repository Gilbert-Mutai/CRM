{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">

  <!-- Page Title -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Angani Clients</h2>
  </div>

  <!-- Actions -->
  <form id="bulk-action-form" method="get" class="mb-3">
    <div class="row g-2 align-items-center">
      <div class="col-auto" style="min-width: 220px;">
        <input type="text" id="search-input" name="search" class="form-control form-control-sm"
               placeholder="Search" value="{{ search_query }}" autocomplete="off">
      </div>
      <div class="col-auto" style="min-width: 160px;">
        <select name="client_type" id="client-type-filter" class="form-select form-select-sm">
          <option value="">All Client Types</option>
          {% for ct in client_types %}
            <option value="{{ ct }}" {% if ct == selected_client_type %}selected{% endif %}>
              {{ ct }}
            </option>
          {% endfor %}
        </select>
      </div>

      
      <div class="col-auto ms-auto">
        <div id="bulk-action-buttons" style="display: none;">
          <a href="#" class="btn btn-sm btn-success me-2" id="send-notification">Send Notification</a>
          <a href="#" class="btn btn-sm btn-primary" id="export-selected">Export Selected</a>
        </div>
      </div>
    </div>
  </form>

  <!-- Table -->
  <div class="table-responsive">
    <table class="table table-striped table-hover table-bordered">
      <thead class="table-primary">
        <tr>
          <th><input type="checkbox" id="select-all" title="Select All" /></th>
          <th>Name</th>
          <th>Client Type</th>
          <th>Contact Person</th>
          <th>Email</th>
          <th>Phone Number</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        {% for client in clients %}
          <tr data-href="{% url 'client_record' client.id %}" tabindex="0">
            <td><input type="checkbox" class="record-checkbox" value="{{ client.email }}" /></td>
            <td>{{ client.name }}</td>
            <td>{{ client.client_type }}</td>
            <td>{{ client.contact_person }}</td>
            <td>{{ client.email }}</td>
            <td>{{ client.phone_number }}</td>
            <td>
              <a href="{% url 'client_record' client.id %}" class="btn btn-outline-primary btn-sm">View</a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="7" class="text-center">No clients found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if clients.has_other_pages %}
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        {% if clients.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ clients.previous_page_number }}&{{ request.GET.urlencode }}" aria-label="Previous">
              &laquo;
            </a>
          </li>
        {% endif %}
        {% for num in clients.paginator.page_range %}
          <li class="page-item {% if clients.number == num %}active{% endif %}">
            <a class="page-link" href="?page={{ num }}&{{ request.GET.urlencode }}">{{ num }}</a>
          </li>
        {% endfor %}
        {% if clients.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ clients.next_page_number }}&{{ request.GET.urlencode }}" aria-label="Next">
              &raquo;
            </a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

</div>

<!-- JavaScript -->
<script>
  // Debounce function to limit how often the search triggers
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  const form = document.getElementById('bulk-action-form');
  const searchInput = document.getElementById('search-input');
  const clientTypeFilter = document.getElementById('client-type-filter');

  // Submit form when client type filter changes immediately
  clientTypeFilter.addEventListener('change', () => {
    form.submit();
  });

  // Submit form when typing stops for 500ms
  searchInput.addEventListener('input', debounce(() => {
    form.submit();
  }, 500));

  // Clickable rows (excluding checkbox and View button)
  document.querySelectorAll('tr[data-href]').forEach(row => {
    row.addEventListener('click', function(e) {
      if (!e.target.closest('input[type="checkbox"]') && !e.target.closest('a')) {
        window.location.href = this.dataset.href;
      }
    });
  });

  // Function to update bulk actions visibility
  function updateBulkActionsVisibility() {
    const checkedCount = document.querySelectorAll('.record-checkbox:checked').length;
    const bulkActions = document.getElementById('bulk-action-buttons');
    if (checkedCount > 0) {
      bulkActions.style.display = 'flex';  // shows the buttons
    } else {
      bulkActions.style.display = 'none';  // hides the buttons
    }
  }

  // Select all checkboxes
  document.getElementById('select-all').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.record-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateBulkActionsVisibility();
  });

  // Individual checkbox change event
  document.querySelectorAll('.record-checkbox').forEach(cb => {
    cb.addEventListener('change', updateBulkActionsVisibility);
  });

  // Initialize bulk actions visibility on page load
  document.addEventListener('DOMContentLoaded', updateBulkActionsVisibility);

  // Send Notification
  document.getElementById('send-notification').addEventListener('click', function(e) {
    e.preventDefault();
    const emails = Array.from(document.querySelectorAll('.record-checkbox:checked'))
                        .map(cb => cb.value);
    if (emails.length === 0) {
      alert("Please select at least one client to send notification.");
      return;
    }
    const queryString = new URLSearchParams({emails: emails.join(',')}).toString();
    window.location.href = "{% url 'send_notification' %}?" + queryString;
  });

  // Export Selected
  document.getElementById('export-selected').addEventListener('click', function(e) {
    e.preventDefault();
    const emails = Array.from(document.querySelectorAll('.record-checkbox:checked'))
                        .map(cb => cb.value);
    if (emails.length === 0) {
      alert("Please select at least one client to export.");
      return;
    }
    const queryString = new URLSearchParams({emails: emails.join(',')}).toString();
    window.location.href = "{% url 'export_clients' %}?" + queryString;
  });
</script>

{% endblock %}
